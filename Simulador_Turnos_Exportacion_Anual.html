<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Turnos üêü ‚Äî Planificador Industrial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { --glass-bg: rgba(255, 255, 255, .58); --glass-stroke: rgba(255, 255, 255, .35); }
    html, body { height: 100%; overflow-x: hidden; width: 100%; max-width: 100vw; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #c9d6ff 0%, transparent 60%),
                  radial-gradient(1000px 500px at 90% 10%, #e2d1f9 0%, transparent 55%),
                  linear-gradient(135deg, #eef2ff 0%, #e0e7ff 20%, #fdf2f8 100%);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      color: #0f172a;
    }
    .dark body {
      background: radial-gradient(1200px 600px at 20% 0%, #0b1220 0%, transparent 60%),
                  radial-gradient(1000px 500px at 90% 10%, #171a29 0%, transparent 55%),
                  linear-gradient(135deg, #0b1220 0%, #0f172a 30%, #111827 100%);
      color: #e5e7eb;
    }
    .dark :root { --glass-bg: rgba(17, 24, 39, .65); --glass-stroke: rgba(255,255,255,.08); }
    .glass { background: var(--glass-bg); backdrop-filter: blur(14px) saturate(120%); -webkit-backdrop-filter: blur(14px) saturate(120%); border: 1px solid var(--glass-stroke); box-shadow: 0 10px 30px rgba(2, 8, 23, .08), inset 0 1px 0 rgba(255,255,255,.25); }
    .sticky-left { position: sticky; left: 0; z-index: 10; }
    .chip { border-radius: 9999px; padding: .25rem .6rem; font-weight: 700; font-size: .75rem; }
    .cell-mini { font-size: .7rem; line-height: 1.1rem; }
    .print\:show { display: none; }
    @media print {
      .no-print { display: none !important; }
      header, .config-area, .groups-palette, .zones-area, .tabs-area { display: none !important; }
      #printArea { display: block !important; }
      body { background: white; color: #111827; }
      table { page-break-inside: avoid; }
    }
    /* Turno palettes */
    .shift-day{background-color:#fef3c7;border-left:3px solid #f59e0b;color:#92400e}
    .shift-afternoon{background-color:#fed7aa;border-left:3px solid #ea580c;color:#9a3412}
    .shift-night{background-color:#c7d2fe;border-left:3px solid #4f46e5;color:#3730a3}
    .shift-rest{background-color:#d1fae5;border-left:3px solid #10b981;color:#065f46}
    .badge { position:absolute; top:2px; right:2px; font-size:.6rem; background:#fbbf24; color:#78350f; padding:2px 4px; border-radius:4px; }
    .kbd { border:1px solid #cbd5e1; background:#f8fafc; border-bottom-width:2px; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.75rem }
    
    /* Contenedor de calendario con scroll controlado */
    .calendar-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: visible;
      border-radius: 12px;
      border: 2px solid rgba(203, 213, 225, 0.5);
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    
    .calendar-container::-webkit-scrollbar { height: 12px; }
    .calendar-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
    .calendar-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 6px; }
    .calendar-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    .scroll-hint {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(90deg, #dbeafe 0%, #e0e7ff 100%);
      border-radius: 8px;
      font-size: 0.875rem;
      color: #475569;
      margin-bottom: 12px;
      border-left: 4px solid #3b82f6;
    }
    
    .sticky-left {
      background: white !important;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
    }

    /* Drag & Drop feedback */
    .dragging {
      opacity: 0.5;
      transform: scale(0.95);
      cursor: grabbing !important;
    }
    .drag-over {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%) !important;
      border: 2px dashed #6366f1 !important;
      transform: scale(1.02);
      transition: all 0.2s ease;
    }
    .draggable-item {
      cursor: grab;
      transition: all 0.2s ease;
    }
    .draggable-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(99, 102, 241, 0.3);
      border-radius: 50%;
      border-top-color: #6366f1;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast mejorado */
    .toast {
      position: fixed;
      z-index: 9999;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }
    .toast-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .toast-error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .toast-info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Navigation buttons */
    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .nav-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Breadcrumb */
    .breadcrumb {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .mobile-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 80%;
        max-width: 320px;
        height: 100vh;
        background: white;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 9999;
        overflow-y: auto;
      }
      .mobile-menu.open {
        transform: translateX(0);
      }
      .nav-btn, .tab-btn {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* Tooltip mejorado */
    .tooltip {
      position: relative;
    }
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.95);
      color: white;
      font-size: 0.75rem;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
    }
    .tooltip:hover::after {
      opacity: 1;
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Focus visible mejorado para accesibilidad */
    *:focus-visible {
      outline: 2px solid #6366f1;
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* Construcci√≥n manual de turnos */
    .manual-shift-chip {
      cursor: grab;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.875rem;
      user-select: none;
    }
    .manual-shift-chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .manual-shift-chip.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .manual-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 12px;
    }

    .manual-day-cell {
      min-height: 80px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px;
      background: white;
      transition: all 0.2s ease;
      position: relative;
    }

    .manual-day-cell:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .manual-day-cell.drag-over-manual {
      border-color: #6366f1;
      background: rgba(99, 102, 241, 0.05);
      border-style: dashed;
    }

    .manual-day-cell.disabled {
      background: #f1f5f9;
      opacity: 0.5;
      pointer-events: none;
    }

    .manual-day-header {
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .manual-day-number {
      font-size: 0.875rem;
      font-weight: 700;
      color: #1e293b;
    }

    .manual-day-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 40px;
    }

    .manual-shift-assigned {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .manual-shift-assigned:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .manual-shift-assigned .remove-shift {
      display: inline-block;
      margin-left: 4px;
      opacity: 0.7;
      font-size: 0.7rem;
    }

    .manual-shift-assigned:hover .remove-shift {
      opacity: 1;
    }

    .calendar-week-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 0.75rem;
      color: #475569;
      text-align: center;
    }

    .calendar-week-day {
      padding: 8px;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      border-radius: 6px;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="glass rounded-2xl mx-auto max-w-7xl mt-6 p-5" role="banner">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">üìÖ Simulador de Turnos üêü</h1>
        <p class="text-slate-600 dark:text-slate-300" role="doc-subtitle">Planificaci√≥n con vista horizontal de 3 meses continuos</p>
      </div>
      <div class="flex items-center gap-2 no-print" role="toolbar" aria-label="Herramientas principales">
        <button id="btnHelp" class="px-3 py-2 glass rounded-xl hover:bg-white/60 tooltip" data-tooltip="Ver atajos de teclado" aria-label="Ayuda y atajos de teclado">‚ùì</button>
        <button id="btnUndo" class="px-3 py-2 glass rounded-xl hover:bg-white/60 tooltip" data-tooltip="Deshacer (Ctrl/‚åò+Z)" aria-label="Deshacer">‚Ü©Ô∏è</button>
        <button id="btnRedo" class="px-3 py-2 glass rounded-xl hover:bg-white/60 tooltip" data-tooltip="Rehacer (Ctrl/‚åò+Shift+Z)" aria-label="Rehacer">‚Ü™Ô∏è</button>
        <button id="btnDark" class="px-3 py-2 glass rounded-xl hover:bg-white/60 tooltip" data-tooltip="Cambiar tema" aria-label="Cambiar tema oscuro/claro">üåó</button>
        <button id="btnMobileMenu" class="px-3 py-2 glass rounded-xl hover:bg-white/60 md:hidden" aria-label="Men√∫">‚ò∞</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto mt-6 grid gap-6" role="main">
    <!-- CONFIG -->
    <section class="glass rounded-2xl p-6 config-area" aria-label="Configuraci√≥n">
      <h2 class="text-xl font-extrabold mb-4">‚öôÔ∏è Configuraci√≥n r√°pida</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label for="startDate" class="block text-sm font-semibold mb-2">Fecha inicio</label>
          <input type="date" id="startDate" aria-label="Fecha de inicio de planificaci√≥n" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-400" />
        </div>
        <div>
          <label for="endDate" class="block text-sm font-semibold mb-2">Fecha fin</label>
          <input type="date" id="endDate" aria-label="Fecha de fin de planificaci√≥n" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-400" />
        </div>
        <div>
          <label for="visibleMonth" class="block text-sm font-semibold mb-2">Navegaci√≥n de meses</label>
          <div class="flex gap-2 items-center">
            <button id="btnPrevMonth" class="nav-btn glass px-3 py-2 rounded-xl hover:bg-white/60" aria-label="Mes anterior">‚óÄ</button>
            <select id="visibleMonth" aria-label="Seleccionar mes visible" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-400"></select>
            <button id="btnNextMonth" class="nav-btn glass px-3 py-2 rounded-xl hover:bg-white/60" aria-label="Mes siguiente">‚ñ∂</button>
          </div>
          <div id="breadcrumbRange" class="breadcrumb mt-2 text-center" role="status" aria-live="polite"></div>
        </div>
        <div class="flex gap-2 items-end">
          <button id="btnExportXLSX" class="flex-1 bg-emerald-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-emerald-700" aria-label="Exportar planificaci√≥n a Excel">üì• Exportar Excel</button>
          <button id="btnPrint" class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-white/60" aria-label="Imprimir planificaci√≥n">üñ®Ô∏è Imprimir</button>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 no-print items-center">
        <button id="btnSave" class="px-3 py-2 glass rounded-xl" aria-label="Guardar configuraci√≥n">üíæ Guardar</button>
        <button id="btnLoad" class="px-3 py-2 glass rounded-xl" aria-label="Cargar configuraci√≥n guardada">üìÇ Cargar</button>
        <button id="btnReset" class="px-3 py-2 glass rounded-xl text-rose-700" aria-label="Resetear a configuraci√≥n inicial">üßπ Reset</button>

        <div class="ml-auto flex items-center gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 px-4 py-2 rounded-xl border-2 border-indigo-200">
          <span class="text-sm font-semibold text-slate-700">Modo:</span>
          <button id="btnToggleMode" class="px-4 py-2 rounded-lg font-bold transition-all" aria-label="Alternar entre modo autom√°tico y manual">
            <span id="modeLabel">ü§ñ Autom√°tico</span>
          </button>
        </div>
      </div>
    </section>

    <!-- GROUPS PALETTE -->
    <section class="glass rounded-2xl p-6 groups-palette" aria-label="Paleta de grupos">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-extrabold">üë• Grupos disponibles</h2>
        <div class="text-slate-500 text-sm flex items-center gap-2">
          <span class="hidden md:inline">üëÜ Arrastra una ficha de ciclo a un turno</span>
          <button id="btnTutorial" class="text-indigo-600 hover:text-indigo-800 font-semibold" aria-label="Ver tutorial de uso">Ver tutorial</button>
        </div>
      </div>
      <div id="groupsPalette" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3" role="list"></div>
    </section>

    <!-- DROP ZONES -->
    <section class="grid md:grid-cols-3 gap-6 zones-area" aria-label="Zonas de turnos">
      <div class="glass rounded-2xl p-5" id="zone-day" data-drop-zone="day" role="region" aria-label="Turno d√≠a"></div>
      <div class="glass rounded-2xl p-5" id="zone-afternoon" data-drop-zone="afternoon" role="region" aria-label="Turno tarde"></div>
      <div class="glass rounded-2xl p-5" id="zone-night" data-drop-zone="night" role="region" aria-label="Turno noche"></div>
    </section>

    <!-- TABS -->
    <section class="grid gap-4 tabs-area">
      <div class="flex flex-wrap gap-2 no-print" role="tablist" aria-label="Vistas del calendario">
        <button class="tab-btn px-3 py-2 glass rounded-xl font-semibold" data-tab="by-group" role="tab" aria-controls="tabContent">üë• Vista por grupos</button>
        <button class="tab-btn px-3 py-2 glass rounded-xl font-semibold" data-tab="by-shift" role="tab" aria-controls="tabContent">üìä Vista por turnos</button>
        <button class="tab-btn px-3 py-2 glass rounded-xl font-semibold" data-tab="manual" role="tab" aria-controls="tabContent">‚úèÔ∏è Construcci√≥n manual</button>
        <button class="tab-btn px-3 py-2 glass rounded-xl font-semibold" data-tab="stats" role="tab" aria-controls="tabContent">üìà M√©tricas & domingos</button>
        <button class="tab-btn px-3 py-2 glass rounded-xl font-semibold" data-tab="rules" role="tab" aria-controls="tabContent">‚úÖ Validador de reglas</button>
      </div>
      <div id="tabContent" class="glass rounded-2xl p-4 overflow-x-auto" role="tabpanel"></div>
      <div class="print:show text-xs text-slate-500">Generado por Simulador de Turnos PRO v2</div>
    </section>
  </main>

  <!-- Modal de ayuda -->
  <div id="helpModal" class="hidden"></div>

  <!-- Modal de tutorial -->
  <div id="tutorialModal" class="hidden"></div>

  <!-- Modal de vista previa -->
  <div id="previewModal" class="hidden"></div>

  <!-- √Årea para imprimir -->
  <div id="printArea" class="hidden">
    <div class="p-6">
      <h2 class="text-2xl font-extrabold mb-2">Distribuci√≥n de Grupos</h2>
      <div id="printZones"></div>
      <h2 class="text-2xl font-extrabold mt-6 mb-2">Calendario ‚Äî Vista por grupos</h2>
      <div id="printByGroup"></div>
      <h2 class="text-2xl font-extrabold mt-6 mb-2">Calendario ‚Äî Vista por turnos</h2>
      <div id="printByShift"></div>
    </div>
  </div>

  <template id="tpl-zone">
    <div class="min-h-[420px]">
      <h3 class="text-2xl font-extrabold mb-2 text-center"></h3>
      <div class="text-center text-sm text-slate-600 mb-4">(<span class="js-count"></span>/<span class="js-cap"></span> grupos)</div>
      <div class="space-y-3 js-cards"></div>
      <div class="js-empty hidden border-2 border-dashed rounded-xl py-10 text-center text-slate-500">Arrastra aqu√≠ para asignar</div>
    </div>
  </template>

  <script>
    // ---------- STATE ----------
    const defaultState = {
      startDate: '2025-10-01',
      endDate:   '2027-09-30',
      selectedMonth: null, // se sincroniza con startDate en init y en cambios
      maxGroupsPerShift: 4,
      groups: ['1','2','3','4','A2','B2','C2','D2'],
      shiftAssignments: {
        day:       [{ groupId: '1', cycle1: '6x1', cycle2: null, cycle1Repeat: 1, cycle2Repeat: 1, startOffset: 0 }],
        afternoon: [{ groupId: '2', cycle1: '6x1', cycle2: null, cycle1Repeat: 1, cycle2Repeat: 1, startOffset: 0 }],
        night:     [{ groupId: '3', cycle1: '5x2', cycle2: null, cycle1Repeat: 1, cycle2Repeat: 1, startOffset: 0 }],
      },
      rules: { minFreeSundaysPerMonth: 2, maxConsecutiveWorkDays: 6 },
      manualMode: false, // true = modo manual, false = modo autom√°tico
      manualAssignments: {
        day:       [],
        afternoon: [],
        night:     []
      },
      manualDays: {}, // { 'YYYY-MM-DD': 'day' | 'afternoon' | 'night' | 'rest' }
      manualCalendar: {} // DEPRECATED: mantener para compatibilidad con versiones antiguas
    };

    let state = JSON.parse(JSON.stringify(defaultState));

    // Undo/Redo stacks
    const undoStack = []; const redoStack = [];

    const groupColors = { '1': 'bg-purple-500 text-white','2': 'bg-pink-500 text-white','3': 'bg-blue-500 text-white','4': 'bg-green-500 text-white','A2': 'bg-amber-500 text-white','B2': 'bg-cyan-500 text-white','C2': 'bg-rose-500 text-white','D2': 'bg-teal-500 text-white' };
    const groupBorders = { '1': 'border-purple-500','2': 'border-pink-500','3': 'border-blue-500','4': 'border-green-500','A2': 'border-amber-500','B2': 'border-cyan-500','C2': 'border-rose-500','D2': 'border-teal-500' };

    const clone = (o)=> JSON.parse(JSON.stringify(o));
    const pushHistory = ()=>{ undoStack.push(clone(state)); redoStack.length = 0; };

    // ---------- UTILS ----------
    const cycleTuple = (t)=> ({'4x3':[4,3],'5x2':[5,2],'6x1':[6,1]})[t];
    const daysInMonth = (yyyyMM)=>{ const [y,m] = yyyyMM.split('-').map(Number); const count=new Date(y,m,0).getDate(); const arr=[]; for(let d=1; d<=count; d++){ const iso=`${yyyyMM}-${String(d).padStart(2,'0')}`; const dt=new Date(iso); arr.push({date:iso, js:dt, isSunday: dt.getDay()===0}); } return arr; };

    function buildEngine(){
      const start=new Date(state.startDate), end=new Date(state.endDate);
      const calendar={ day:[], afternoon:[], night:[] }; const byGroup={}; const engine={};
      ['day','afternoon','night'].forEach(shift=>{
        state.shiftAssignments[shift].forEach(a=>{
          if(!engine[a.groupId]){
            const c1=cycleTuple(a.cycle1); const c2=a.cycle2?cycleTuple(a.cycle2):null; const span=c1[0]+c1[1]; const startCycle=(a.startOffset||0)%span;
            engine[a.groupId]={ shift, cycle1:a.cycle1, cycle2:a.cycle2, c1Work:c1[0], c1Span:c1[0]+c1[1], c2Work:c2?c2[0]:null, c2Span:c2?c2[0]+c2[1]:null, cycleDay:startCycle, cycleType:1, reps:0 };
            byGroup[a.groupId]=[];
          }
        });
      });
      for(let t=new Date(start); t<=end; t.setDate(t.getDate()+1)){
        const dateStr = t.toISOString().slice(0,10); const isSunday = t.getDay()===0;
        const row = { day:{date:dateStr,isSunday,groups:[]}, afternoon:{date:dateStr,isSunday,groups:[]}, night:{date:dateStr,isSunday,groups:[]} };
        Object.keys(engine).forEach(g=>{
          const e=engine[g]; const workDays=e.cycleType===1?e.c1Work:e.c2Work; const span=e.cycleType===1?e.c1Span:e.c2Span; const isWork=e.cycleDay<workDays;
          row[e.shift].groups.push({groupId:g,isWorking:isWork,currentCycleType:e.cycleType});
          byGroup[g].push({date:dateStr,isSunday,isWorking:isWork,shift:isWork?e.shift:'rest',currentCycleType:e.cycleType});
          e.cycleDay++; if(e.cycleDay>=span){ e.cycleDay=0; e.reps++; if(e.cycle2){ e.cycleType = e.cycleType===1?2:1; e.reps=0; } e.shift = e.shift==='day'? 'afternoon' : e.shift==='afternoon'? 'night' : 'day'; }
        });
        calendar.day.push(row.day); calendar.afternoon.push(row.afternoon); calendar.night.push(row.night);
      }
      return {calendar, byGroup};
    }

    function buildManualCalendar(){
      const start=new Date(state.startDate), end=new Date(state.endDate);
      const calendar={ day:[], afternoon:[], night:[] };

      // Generar calendario d√≠a por d√≠a usando manualDays
      for(let t=new Date(start); t<=end; t.setDate(t.getDate()+1)){
        const dateStr = t.toISOString().slice(0,10);
        const isSunday = t.getDay()===0;
        const assignedShift = state.manualDays[dateStr] || 'rest';

        const row = {
          day:{date:dateStr,isSunday,groups:[]},
          afternoon:{date:dateStr,isSunday,groups:[]},
          night:{date:dateStr,isSunday,groups:[]}
        };

        // Si el d√≠a tiene un turno asignado, agregar un grupo gen√©rico
        if(assignedShift !== 'rest'){
          row[assignedShift].groups.push({
            groupId:'MANUAL',
            isWorking:true,
            currentCycleType:1
          });
        }

        calendar.day.push(row.day);
        calendar.afternoon.push(row.afternoon);
        calendar.night.push(row.night);
      }

      // Para byGroup, crear un solo grupo "MANUAL" que muestra todos los d√≠as asignados
      const byGroup = { 'MANUAL': [] };
      for(let t=new Date(start); t<=end; t.setDate(t.getDate()+1)){
        const dateStr = t.toISOString().slice(0,10);
        const isSunday = t.getDay()===0;
        const assignedShift = state.manualDays[dateStr] || 'rest';

        byGroup['MANUAL'].push({
          date:dateStr,
          isSunday,
          isWorking: assignedShift !== 'rest',
          shift: assignedShift,
          currentCycleType:1
        });
      }

      return {calendar, byGroup};
    }

    // Funci√≥n para aplicar un ciclo desde una fecha inicial
    function applyCycleToManual(startDate, shift, cycleType) {
      if (!state.manualDays) {
        state.manualDays = {};
      }

      const [workDays, restDays] = cycleTuple(cycleType);
      const totalDays = workDays + restDays;

      // Aplicar el ciclo por 90 d√≠as (aproximadamente 3 meses)
      let currentDate = new Date(startDate);
      const endDate = new Date(currentDate);
      endDate.setDate(endDate.getDate() + 90);

      let dayInCycle = 0;
      while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().slice(0, 10);

        if (dayInCycle < workDays) {
          state.manualDays[dateStr] = shift;
        } else {
          state.manualDays[dateStr] = 'rest';
        }

        dayInCycle++;
        if (dayInCycle >= totalDays) {
          dayInCycle = 0;
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }
    }

    const monthsAvailable = (calendar)=>{ const set=new Set(); calendar.day.forEach(d=>set.add(d.date.slice(0,7))); return Array.from(set).sort(); };
    function monthByGroup(byGroup, yyyyMM){ const days=daysInMonth(yyyyMM); const out={}; Object.keys(byGroup).forEach(g=>{ const map=new Map(byGroup[g].map(d=>[d.date,d])); out[g]=days.map(x=> map.get(x.date) || {date:x.date,isSunday:x.isSunday,shift:'rest',isWorking:false,currentCycleType:1}); }); return out; }
    function monthByShift(calendar, yyyyMM){ const start=`${yyyyMM}-01`; const endDt=daysInMonth(yyyyMM).slice(-1)[0].date; const sliced={day:[],afternoon:[],night:[]}; ['day','afternoon','night'].forEach(k=>{ sliced[k]=calendar[k].filter(d=> d.date>=start && d.date<=endDt); }); return sliced; }

    // Funci√≥n para detectar la pesta√±a activa
    const currentTab=()=> document.querySelector('.tab-btn.bg-white\\/60')?.dataset.tab || 'by-group';

    // ---------- RENDER ----------
    function renderAll(){
      // Usar calendario manual o autom√°tico seg√∫n el modo
      const {calendar, byGroup} = state.manualMode ? buildManualCalendar() : buildEngine();
      if(!state.selectedMonth){ state.selectedMonth = state.startDate.slice(0,7); }
      const select = document.getElementById('visibleMonth');
      const opts = monthsAvailable(calendar);
      if(!opts.includes(state.selectedMonth)) state.selectedMonth = opts[0] || state.startDate.slice(0,7);
      select.innerHTML = opts.map(m=>`<option value="${m}" ${m===state.selectedMonth?'selected':''}>${new Date(m+'-01').toLocaleDateString('es-CL',{month:'long',year:'numeric'})}</option>`).join('');

      const pal = document.getElementById('groupsPalette');
      pal.innerHTML = state.groups.map(g=>{
        return `<div class="space-y-2">
          <div class="${groupColors[g]} rounded-xl p-2 text-center font-bold">G${g}</div>
          ${['4x3','5x2','6x1'].map(c=>`<div draggable="true" data-group="${g}" data-cycle="${c}" class="draggable-item border-2 ${groupBorders[g]} bg-white rounded-xl p-2 text-center font-semibold text-xs" title="Arrastra al turno deseado">‚ãÆ‚ãÆ ${c}</div>`).join('')}
        </div>`;
      }).join('');

      const packs=[{id:'zone-day', key:'day', title:'‚òÄÔ∏è D√çA', color:'text-amber-900'},{id:'zone-afternoon', key:'afternoon', title:'üå§Ô∏è TARDE', color:'text-orange-900'},{id:'zone-night', key:'night', title:'üåô NOCHE', color:'text-indigo-900'}];
      packs.forEach(p=>{
        const host=document.getElementById(p.id); const tpl=document.getElementById('tpl-zone').content.cloneNode(true);
        tpl.querySelector('h3').className=`text-2xl font-extrabold mb-2 text-center ${p.color}`; tpl.querySelector('h3').textContent=p.title;
        tpl.querySelector('.js-cap').textContent=state.maxGroupsPerShift; const cards=tpl.querySelector('.js-cards');
        // Usar asignaciones manuales o autom√°ticas seg√∫n el modo
        const list=state.manualMode ? state.manualAssignments[p.key] : state.shiftAssignments[p.key];
        tpl.querySelector('.js-count').textContent=list.length; tpl.querySelector('.js-empty').classList.toggle('hidden', list.length>0);
        cards.innerHTML=list.map((a,idx)=>{
          return `<div class="border-2 ${groupBorders[a.groupId]} bg-white rounded-xl p-3">
            <div class="flex items-center justify-between mb-2">
              <span class="${groupColors[a.groupId]} chip">G${a.groupId}</span>
              <div class="flex gap-2">
                <button data-action="dup" data-shift="${p.key}" data-idx="${idx}" class="text-slate-500 hover:text-slate-700" title="Duplicar">‚éò</button>
                <button data-action="del" data-shift="${p.key}" data-idx="${idx}" class="text-rose-600 hover:text-rose-800" title="Eliminar">üóëÔ∏è</button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="text-xs font-semibold">Ciclo 1
                <select data-action="c1" data-shift="${p.key}" data-idx="${idx}" class="w-full px-2 py-1 border rounded text-sm">
                  ${['4x3','5x2','6x1'].map(c=>`<option value="${c}" ${a.cycle1===c?'selected':''}>${c}</option>`).join('')}
                </select>
              </label>
              <label class="text-xs font-semibold">Ciclo 2
                <select data-action="c2" data-shift="${p.key}" data-idx="${idx}" class="w-full px-2 py-1 border rounded text-sm">
                  <option value="">Sin ciclo 2</option>
                  ${['4x3','5x2','6x1'].map(c=>`<option value="${c}" ${a.cycle2===c?'selected':''}>${c}</option>`).join('')}
                </select>
              </label>
              <label class="text-xs font-semibold">Desfase
                <input type="number" min="0" max="30" value="${a.startOffset||0}" data-action="ofs" data-shift="${p.key}" data-idx="${idx}" class="w-full px-2 py-1 border rounded text-sm" />
              </label>
              <label class="text-xs font-semibold">Repeticiones C1
                <select data-action="r1" data-shift="${p.key}" data-idx="${idx}" class="w-full px-2 py-1 border rounded text-sm">
                  ${[1,2,3].map(n=>`<option value="${n}" ${a.cycle1Repeat===n?'selected':''}>${n}x</option>`).join('')}
                </select>
              </label>
            </div>
          </div>`;
        }).join('');
        host.innerHTML=''; host.appendChild(tpl);
      });

      // Guardar la pesta√±a activa actual antes de renderizar
      const activeTab = currentTab();
      renderTab(activeTab, {calendar, byGroup});
      wireDnD(); wireZoneButtons();
    }

    // === NUEVO: render de 3 meses consecutivos para vistas por grupo y por turno ===
    function renderTab(tab, data){
      const wrap=document.getElementById('tabContent');
      const {calendar, byGroup} = data || buildEngine();
      const baseMonth = new Date(state.selectedMonth + '-01');

      // Genera los pr√≥ximos 3 meses
      const months = [];
      for (let i = 0; i < 3; i++) {
        const m = new Date(baseMonth);
        m.setMonth(baseMonth.getMonth() + i);
        months.push(m.toISOString().slice(0, 7));
      }

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-white/60'));
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
      if (activeBtn) activeBtn.classList.add('bg-white/60');

      if (tab === 'by-group') {
        // UNA SOLA TABLA con 3 meses lineales
        wrap.innerHTML = htmlByGroup(byGroup, months);
      }

      if (tab === 'by-shift') {
        // UNA SOLA TABLA con 3 meses lineales
        wrap.innerHTML = htmlByShift(calendar, months);
      }

      if (tab === 'stats') {
        const s = sundayStats(calendar, 6);
        const totals = totalsFromSunday(s);
        wrap.innerHTML = renderStats(s, totals);
      }

      if (tab === 'rules') {
        const s = sundayStats(calendar, 6);
        wrap.innerHTML = renderRules(s);
      }

      if (tab === 'manual') {
        wrap.innerHTML = renderManualCalendar();
        wireManualDnD();
      }
    }

    function htmlByGroup(byGroup, months){
      // Si months es string (un solo mes), convertir a array de 3 meses
      if (typeof months === 'string') {
        const baseMonth = new Date(months + '-01');
        months = [];
        for (let i = 0; i < 3; i++) {
          const m = new Date(baseMonth);
          m.setMonth(baseMonth.getMonth() + i);
          months.push(m.toISOString().slice(0, 7));
        }
      }
      
      const groups = Object.keys(byGroup); 
      if(groups.length === 0) return emptyMsg('Asigna grupos a los turnos para ver el calendario.');
      
      // Combinar todos los d√≠as de los 3 meses
      const allDays = [];
      months.forEach(month => {
        const days = daysInMonth(month);
        allDays.push(...days);
      });

      // Construir datos por grupo para todos los d√≠as
      const mg = {};
      groups.forEach(g => {
        const map = new Map(byGroup[g].map(d => [d.date, d]));
        mg[g] = allDays.map(x => map.get(x.date) || {date: x.date, isSunday: x.isSunday, shift: 'rest', isWorking: false, currentCycleType: 1});
      });

      return `
      <div class="scroll-hint">
        <span>‚û°Ô∏è Desliza horizontalmente para ver los ${allDays.length} d√≠as de ${months.length} meses</span>
      </div>
      <div class="calendar-container">
      <table class="border-collapse text-xs" style="width: auto; min-width: max-content;">
        <thead>
          <tr class="bg-slate-100">
            <th class="sticky-left border p-2 font-bold bg-slate-100">Grupo</th>
            ${allDays.map(d => {
              const isFirst = d.js.getDate() === 1;
              const mon = d.js.toLocaleDateString('es-CL', {month: 'short'}).toUpperCase();
              return `<th class="border p-1 ${d.isSunday ? 'bg-blue-100' : ''} ${isFirst ? 'border-l-4 border-l-rose-500' : ''}">
                ${isFirst ? `<div class="text-rose-600 font-bold text-[10px]">${mon}</div>` : ''}
                <div class="font-bold">${d.js.getDate()}</div>
                <div class="text-[10px]">${d.js.toLocaleDateString('es-CL', {weekday: 'short'})}</div>
              </th>`;
            }).join('')}
          </tr>
        </thead>
        <tbody>
          ${groups.map(g => `
            <tr>
              <td class="sticky-left border p-2 bg-white">
                <div class="${groupColors[g]} rounded py-1 px-2 text-center text-sm font-bold">G${g}</div>
              </td>
              ${mg[g].map(x => {
                const cls = x.shift === 'day' ? 'shift-day' : x.shift === 'afternoon' ? 'shift-afternoon' : x.shift === 'night' ? 'shift-night' : 'shift-rest';
                const label = x.shift === 'day' ? 'D√≠a' : x.shift === 'afternoon' ? 'Tarde' : x.shift === 'night' ? 'Noche' : 'Descanso';
                return `<td class="border p-1 text-center ${cls} relative" title="${label}">
                  <div class="font-semibold text-[11px] py-1">${label}${x.currentCycleType === 2 ? '<span class="badge">C2</span>' : ''}</div>
                </td>`;
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>
      </div>`;
    }

    function htmlByShift(calendar, months){
      // Si se pasa un objeto con day/afternoon/night (m), convertir a formato esperado
      if (typeof months === 'string' || (months && months.day)) {
        const monthStr = typeof months === 'string' ? months : state.selectedMonth;
        const baseMonth = new Date(monthStr + '-01');
        const monthsArray = [];
        for (let i = 0; i < 3; i++) {
          const m = new Date(baseMonth);
          m.setMonth(baseMonth.getMonth() + i);
          monthsArray.push(m.toISOString().slice(0, 7));
        }
        months = monthsArray;
      }
      
      // Combinar todos los d√≠as de los 3 meses para cada turno
      const allDaysData = {day: [], afternoon: [], night: []};
      
      months.forEach(month => {
        const monthData = monthByShift(calendar, month);
        ['day', 'afternoon', 'night'].forEach(shift => {
          allDaysData[shift].push(...monthData[shift]);
        });
      });

      if(!allDaysData.day || allDaysData.day.length === 0) return emptyMsg('No hay datos para el per√≠odo seleccionado.');

      const days = allDaysData.day;

      return `
      <div class="scroll-hint">
        <span>‚û°Ô∏è Desliza horizontalmente para ver los ${days.length} d√≠as de ${months.length} meses</span>
      </div>
      <div class="calendar-container">
      <table class="border-collapse text-xs" style="width: auto; min-width: max-content;">
        <thead>
          <tr class="bg-slate-100">
            <th class="sticky-left border p-2 font-bold bg-slate-100">Turno</th>
            ${days.map(d => {
              const dt = new Date(d.date);
              const isFirst = dt.getDate() === 1;
              const mon = dt.toLocaleDateString('es-CL', {month: 'short'}).toUpperCase();
              return `<th class="border p-1 ${d.isSunday ? 'bg-blue-100' : ''} ${isFirst ? 'border-l-4 border-l-rose-500' : ''}">
                ${isFirst ? `<div class="text-rose-600 font-bold text-[10px]">${mon}</div>` : ''}
                <div class="font-bold">${dt.getDate()}</div>
                <div class="text-[10px]">${dt.toLocaleDateString('es-CL', {weekday: 'short'})}</div>
              </th>`;
            }).join('')}
          </tr>
        </thead>
        <tbody>
          ${['day', 'afternoon', 'night'].map((shift, idx) => {
            const label = ['‚òÄÔ∏è D√çA', 'üå§Ô∏è TARDE', 'üåô NOCHE'][idx];
            const bg = ['bg-amber-50', 'bg-orange-50', 'bg-indigo-50'][idx];
            const bgSticky = ['bg-amber-100', 'bg-orange-100', 'bg-indigo-100'][idx];
            return `
              <tr class="${bg}">
                <td class="sticky-left border p-2 font-bold ${bgSticky}">${label}</td>
                ${allDaysData[shift].map(d => `
                  <td class="border p-1 text-center">
                    ${d.groups.filter(g => g.isWorking).map(g => `
                      <div class="${groupColors[g.groupId]} cell-mini font-bold py-1 px-1 rounded mb-1 relative">
                        G${g.groupId}${g.currentCycleType === 2 ? '<span class="badge">C2</span>' : ''}
                      </div>
                    `).join('') || '<span class="text-slate-400">-</span>'}
                  </td>
                `).join('')}
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      </div>`;
    }

    function sundayStats(calendar, months=6){ const stats={}; const base=new Date(state.startDate); for(let i=0;i<months;i++){ const m=new Date(base); m.setMonth(base.getMonth()+i); const key=m.toISOString().slice(0,7); stats[key]={}; state.groups.forEach(g=> stats[key][g]={working:0,free:0,total:0}); ['day','afternoon','night'].forEach(shift=>{ calendar[shift].filter(d=> d.date.startsWith(key) && d.isSunday).forEach(d=>{ d.groups.forEach(g=>{ if(!stats[key][g.groupId]) return; stats[key][g.groupId].total++; if(g.isWorking) stats[key][g.groupId].working++; else stats[key][g.groupId].free++; }); }); }); } return stats; }
    function totalsFromSunday(stats){ const totals={}; state.groups.forEach(g=> totals[g]={working:0,free:0,total:0}); Object.values(stats).forEach(m=>{ state.groups.forEach(g=>{ totals[g].working+=(m[g]?.working||0); totals[g].free+=(m[g]?.free||0); totals[g].total+=(m[g]?.total||0); }); }); return totals; }

    function renderStats(sundayStatsObj, totalStats){ const months=Object.keys(sundayStatsObj); return `
      <div class="grid gap-6">
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-xs">
            <thead><tr class="bg-slate-100"><th class="border p-2 font-bold">Mes</th>${state.groups.map(g=>`<th class="border p-2 font-bold"><div class="${groupColors[g]} rounded py-1 px-2 inline-block text-xs">G${g}</div></th>`).join('')}</tr></thead>
            <tbody>${months.map((m,idx)=>`<tr class="${idx%2===0?'bg-white':'bg-slate-50'}"><td class="border p-2 font-semibold">${new Date(m+'-01').toLocaleDateString('es-CL',{month:'short',year:'numeric'})}</td>${state.groups.map(g=>{ const st=sundayStatsObj[m][g]; if(!st||st.total===0) return `<td class=\"border p-2 text-center\">-</td>`; const ok=st.free>=state.rules.minFreeSundaysPerMonth; return `<td class=\"border p-2 text-center ${ok?'bg-emerald-50':'bg-rose-50'}\"><div class=\"font-bold ${ok?'text-emerald-700':'text-rose-700'}\">${st.free}</div><div class=\"text-[10px] text-slate-600\">/${st.total}</div></td>`; }).join('')}</tr>`).join('')}</tbody>
          </table>
        </div>
      </div>`; }

    function renderRules(s){ const issues=[]; Object.entries(s).forEach(([month,groups])=>{ Object.entries(groups).forEach(([g,st])=>{ if(st&&st.total>0&&st.free<state.rules.minFreeSundaysPerMonth){ issues.push({type:'Domingos',month,group:g,msg:`G${g} con ${st.free}/${st.total} domingos libres (< ${state.rules.minFreeSundaysPerMonth})`}); } }); }); const htmlIssues = issues.length? issues.map(i=>`<li class="p-2 rounded bg-rose-50 border border-rose-200">${new Date(i.month+'-01').toLocaleDateString('es-CL',{month:'long',year:'numeric'})}: <strong>${i.msg}</strong></li>`).join('') : '<li class="p-2 rounded bg-emerald-50 border border-emerald-200">Sin observaciones por ahora ‚ú®</li>'; return `
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2"><h3 class="text-lg font-bold mb-2">Alertas de reglas</h3><ul class="space-y-2">${htmlIssues}</ul></div>
        <div class="glass rounded-xl p-4"><h4 class="font-bold mb-2">Par√°metros</h4>
          <label class="block text-sm mb-3">M√≠n. domingos libres/mes <input id="ruleSundays" type="number" min="0" max="4" value="${state.rules.minFreeSundaysPerMonth}" class="w-full mt-1 px-3 py-2 rounded-xl border"></label>
          <label class="block text-sm">M√°x. d√≠as consecutivos de trabajo (alerta) <input id="ruleStreak" type="number" min="3" max="12" value="${state.rules.maxConsecutiveWorkDays}" class="w-full mt-1 px-3 py-2 rounded-xl border"></label>
          <div class="text-xs text-slate-500 mt-3">Estas validaciones son referencias operativas configurables. Verifica siempre tu normativa interna/sectorial.</div>
          <button id="btnApplyRules" class="mt-4 w-full bg-indigo-600 text-white rounded-xl py-2 font-bold hover:bg-indigo-700">Aplicar</button>
        </div>
      </div>`; }

    const emptyMsg = (t)=> `<div class="bg-amber-50 border-l-4 border-amber-400 p-4 text-center">‚ö†Ô∏è ${t}</div>`;

    // ---------- MANUAL CALENDAR ----------
    function renderManualCalendar() {
      // Asegurar que manualDays exista
      if (!state.manualDays) {
        state.manualDays = {};
      }

      const baseMonth = new Date(state.selectedMonth + '-01');
      const months = [];
      for (let i = 0; i < 3; i++) {
        const m = new Date(baseMonth);
        m.setMonth(baseMonth.getMonth() + i);
        months.push(m.toISOString().slice(0, 7));
      }

      // Combinar todos los d√≠as de los 3 meses
      const allDays = [];
      months.forEach(month => {
        const days = daysInMonth(month);
        allDays.push(...days);
      });

      const cycles = ['6x1', '5x2', '4x3'];
      const shifts = [
        { id: 'day', label: 'D√çA', emoji: '‚òÄÔ∏è', color: 'bg-amber-100', borderColor: 'border-amber-500' },
        { id: 'afternoon', label: 'TARDE', emoji: 'üå§Ô∏è', color: 'bg-orange-100', borderColor: 'border-orange-500' },
        { id: 'night', label: 'NOCHE', emoji: 'üåô', color: 'bg-indigo-100', borderColor: 'border-indigo-500' }
      ];

      return `
        <div class="space-y-6">
          <!-- Paletas de ciclos por turno -->
          <div class="grid md:grid-cols-3 gap-4">
            ${shifts.map(shift => `
              <div class="glass rounded-xl p-4 ${shift.borderColor} border-2">
                <h3 class="text-lg font-bold mb-3 text-center ${shift.color} rounded-lg py-2">
                  ${shift.emoji} ${shift.label}
                </h3>
                <div class="space-y-2">
                  ${cycles.map(cycle => `
                    <div
                      draggable="true"
                      data-cycle-shift="${shift.id}"
                      data-cycle-type="${cycle}"
                      class="cursor-grab p-3 bg-white rounded-lg border-2 ${shift.borderColor} hover:shadow-lg transition-all text-center font-bold"
                      title="Arrastra para aplicar ${cycle} de ${shift.label}"
                    >
                      ${cycle}
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <!-- Instrucciones -->
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 border-2 border-blue-200">
            <strong>üí° C√≥mo usar:</strong>
            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
              <li>Arrastra un ciclo (6x1, 5x2, 4x3) desde un turno</li>
              <li>Su√©ltalo en una fecha del calendario</li>
              <li>El patr√≥n se aplicar√° autom√°ticamente desde esa fecha</li>
              <li>Haz clic en un d√≠a para eliminarlo</li>
            </ul>
          </div>

          <!-- Calendario de 3 meses -->
          <div class="scroll-hint">
            <span>‚û°Ô∏è Desliza horizontalmente para ver los ${allDays.length} d√≠as de ${months.length} meses</span>
          </div>
          <div class="calendar-container">
            <table class="border-collapse text-xs" style="width: auto; min-width: max-content;">
              <thead>
                <tr class="bg-slate-100">
                  ${allDays.map(d => {
                    const isFirst = d.js.getDate() === 1;
                    const mon = d.js.toLocaleDateString('es-CL', {month: 'short'}).toUpperCase();
                    return `<th class="border p-1 ${d.isSunday ? 'bg-blue-100' : ''} ${isFirst ? 'border-l-4 border-l-rose-500' : ''}" data-drop-manual-day="${d.date}">
                      ${isFirst ? `<div class="text-rose-600 font-bold text-[10px]">${mon}</div>` : ''}
                      <div class="font-bold">${d.js.getDate()}</div>
                      <div class="text-[10px]">${d.js.toLocaleDateString('es-CL', {weekday: 'short'})}</div>
                    </th>`;
                  }).join('')}
                </tr>
              </thead>
              <tbody>
                <tr>
                  ${allDays.map(d => {
                    const assignedShift = state.manualDays[d.date] || 'rest';
                    const cls = assignedShift === 'day' ? 'shift-day' : assignedShift === 'afternoon' ? 'shift-afternoon' : assignedShift === 'night' ? 'shift-night' : 'shift-rest';
                    const label = assignedShift === 'day' ? 'D√≠a' : assignedShift === 'afternoon' ? 'Tarde' : assignedShift === 'night' ? 'Noche' : '-';
                    return `<td class="border p-1 text-center ${cls} cursor-pointer" title="${label}" data-drop-manual-day="${d.date}" data-manual-day-cell="${d.date}">
                      <div class="font-semibold text-[11px] py-1">${label}</div>
                    </td>`;
                  }).join('')}
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Botones de control -->
          <div class="flex gap-2">
            <button id="btnClearManualDays" class="px-4 py-2 bg-rose-100 text-rose-700 rounded-xl hover:bg-rose-200 font-semibold">
              üóëÔ∏è Limpiar todos los d√≠as
            </button>
          </div>
        </div>
      `;
    }

    // ---------- MODALS & HELPERS ----------
    function showModal(title, content, onClose) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl font-bold">${title}</h3>
            <button class="text-2xl hover:text-red-600" onclick="this.closest('.modal-overlay').remove(); ${onClose ? onClose : ''}">&times;</button>
          </div>
          <div>${content}</div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          if(onClose) eval(onClose);
        }
      });
      document.body.appendChild(modal);
      return modal;
    }

    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumbRange');
      if (!breadcrumb) return;

      const base = new Date(state.selectedMonth + '-01');
      const months = [];
      for (let i = 0; i < 3; i++) {
        const m = new Date(base);
        m.setMonth(base.getMonth() + i);
        months.push(m.toLocaleDateString('es-CL', {month: 'short', year: 'numeric'}));
      }
      breadcrumb.textContent = `üìÖ ${months.join(' ‚Üí ')}`;
    }

    function showHelpModal() {
      const content = `
        <div class="space-y-4">
          <div class="p-4 bg-indigo-50 rounded-xl">
            <h4 class="font-bold mb-2">‚å®Ô∏è Atajos de teclado</h4>
            <ul class="space-y-2 text-sm">
              <li><span class="kbd">Ctrl/‚åò + Z</span> ‚Äî Deshacer √∫ltimo cambio</li>
              <li><span class="kbd">Ctrl/‚åò + Shift + Z</span> ‚Äî Rehacer cambio</li>
              <li><span class="kbd">‚Üê</span> / <span class="kbd">‚Üí</span> ‚Äî Navegar entre meses (pr√≥ximamente)</li>
            </ul>
          </div>
          <div class="p-4 bg-emerald-50 rounded-xl">
            <h4 class="font-bold mb-2">üéØ Funciones principales</h4>
            <ul class="space-y-2 text-sm">
              <li><strong>Drag & Drop:</strong> Arrastra fichas de ciclo a las zonas de turnos</li>
              <li><strong>Duplicar:</strong> Usa el bot√≥n ‚éò para clonar una configuraci√≥n</li>
              <li><strong>Vista de 3 meses:</strong> Visualiza 3 meses continuos para mejor planificaci√≥n</li>
              <li><strong>Exportar:</strong> Descarga Excel con 12 meses de planificaci√≥n</li>
            </ul>
          </div>
          <div class="p-4 bg-amber-50 rounded-xl">
            <h4 class="font-bold mb-2">üí° Tips</h4>
            <ul class="space-y-2 text-sm">
              <li>Los cambios se guardan autom√°ticamente en tu navegador</li>
              <li>Usa "Guardar" para crear un respaldo manual</li>
              <li>El validador de reglas te ayuda a cumplir normativas laborales</li>
            </ul>
          </div>
        </div>
      `;
      showModal('üìñ Gu√≠a de uso', content);
    }

    function showTutorialModal() {
      const content = `
        <div class="space-y-4">
          <div class="p-4 bg-blue-50 rounded-xl border-l-4 border-blue-500">
            <h4 class="font-bold mb-2">Paso 1: Arrastra una ficha</h4>
            <p class="text-sm">Selecciona una ficha de ciclo (4x3, 5x2, o 6x1) de los grupos disponibles y arr√°strala a la zona de turno deseada (D√≠a, Tarde o Noche).</p>
          </div>
          <div class="p-4 bg-purple-50 rounded-xl border-l-4 border-purple-500">
            <h4 class="font-bold mb-2">Paso 2: Configura el ciclo</h4>
            <p class="text-sm">Una vez asignado, puedes ajustar el ciclo, agregar un ciclo alternado (Ciclo 2), configurar el desfase inicial y el n√∫mero de repeticiones.</p>
          </div>
          <div class="p-4 bg-green-50 rounded-xl border-l-4 border-green-500">
            <h4 class="font-bold mb-2">Paso 3: Visualiza y exporta</h4>
            <p class="text-sm">Usa las pesta√±as para ver diferentes vistas del calendario. Exporta a Excel para compartir o imprimir tu planificaci√≥n.</p>
          </div>
          <div class="text-center mt-4">
            <button onclick="this.closest('.modal-overlay').remove()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700">¬°Entendido!</button>
          </div>
        </div>
      `;
      showModal('üéì Tutorial r√°pido', content);
    }

    // ---------- EVENTS ----------
    function wireBasics(){
      const sd=document.getElementById('startDate'); const ed=document.getElementById('endDate'); const vm=document.getElementById('visibleMonth'); const px=document.getElementById('btnExportXLSX'); const pr=document.getElementById('btnPrint'); const sv=document.getElementById('btnSave'); const ld=document.getElementById('btnLoad'); const rs=document.getElementById('btnReset');

      sd.value=state.startDate; ed.value=state.endDate;

      sd.addEventListener('change', e=>{ pushHistory(); state.startDate=e.target.value; state.selectedMonth = state.startDate.slice(0,7); renderAll(); saveAuto(); updateBreadcrumb(); });
      ed.addEventListener('change', e=>{ pushHistory(); state.endDate=e.target.value; renderAll(); saveAuto(); });
      vm.addEventListener('change', e=>{ state.selectedMonth=e.target.value; renderTab(currentTab()); updateBreadcrumb(); });

      // Botones de navegaci√≥n de mes
      document.getElementById('btnPrevMonth')?.addEventListener('click', () => {
        const opts = monthsAvailable(buildEngine().calendar);
        const idx = opts.indexOf(state.selectedMonth);
        if (idx > 0) {
          state.selectedMonth = opts[idx - 1];
          renderTab(currentTab());
          updateBreadcrumb();
          document.getElementById('visibleMonth').value = state.selectedMonth;
        }
      });

      document.getElementById('btnNextMonth')?.addEventListener('click', () => {
        const opts = monthsAvailable(buildEngine().calendar);
        const idx = opts.indexOf(state.selectedMonth);
        if (idx < opts.length - 1) {
          state.selectedMonth = opts[idx + 1];
          renderTab(currentTab());
          updateBreadcrumb();
          document.getElementById('visibleMonth').value = state.selectedMonth;
        }
      });

      // Modales
      document.getElementById('btnHelp')?.addEventListener('click', showHelpModal);
      document.getElementById('btnTutorial')?.addEventListener('click', showTutorialModal);

      px.addEventListener('click', exportXLSX);

      // Print: solo zonas + calendarios grupo/turnos, ahora por 3 meses
      pr.addEventListener('click', ()=>{
        const {calendar, byGroup} = buildEngine();
        const month = state.selectedMonth;
        const printZones = document.getElementById('printZones');
        const printByGroup = document.getElementById('printByGroup');
        const printByShift = document.getElementById('printByShift');

        // Zonas: clonamos las tarjetas actuales
        const zonesWrapper = document.createElement('div'); zonesWrapper.className='grid md:grid-cols-3 gap-4';
        ['zone-day','zone-afternoon','zone-night'].forEach(id=>{ const sec=document.getElementById(id).cloneNode(true); sec.classList.remove('glass'); sec.classList.add('border','rounded-xl','p-4'); zonesWrapper.appendChild(sec); });
        printZones.innerHTML=''; printZones.appendChild(zonesWrapper);

        // Tablas por 3 meses
        const base = new Date(month + '-01');
        let htmlG = '', htmlS = '';
        for (let i = 0; i < 3; i++) {
          const m = new Date(base);
          m.setMonth(base.getMonth() + i);
          const key = m.toISOString().slice(0,7);
          htmlG += `<h3 class="mt-6 mb-2 font-bold">${new Date(key+'-01').toLocaleDateString('es-CL',{month:'long',year:'numeric'})}</h3>` + htmlByGroup(byGroup, key);
          htmlS += `<h3 class="mt-6 mb-2 font-bold">${new Date(key+'-01').toLocaleDateString('es-CL',{month:'long',year:'numeric'})}</h3>` + htmlByShift(monthByShift(calendar, key));
        }
        printByGroup.innerHTML = htmlG;
        printByShift.innerHTML = htmlS;

        window.print();
      });

      sv.addEventListener('click', ()=>{ localStorage.setItem('turnos_pro_state', JSON.stringify(state)); toast('üíæ Guardado en este navegador', 'success'); });
      ld.addEventListener('click', ()=>{ const raw=localStorage.getItem('turnos_pro_state'); if(!raw) return toast('‚ö†Ô∏è No hay guardado previo', 'error'); pushHistory(); state=JSON.parse(raw); renderAll(); toast('üìÇ Configuraci√≥n cargada', 'success'); });
      rs.addEventListener('click', ()=>{ if(confirm('¬øResetear al estado inicial?')){ pushHistory(); state=clone(defaultState); renderAll(); saveAuto(); toast('üßπ Sistema reseteado', 'info'); }});

      // Undo/Redo
      document.getElementById('btnUndo').addEventListener('click', undo);
      document.getElementById('btnRedo').addEventListener('click', redo);
      document.addEventListener('keydown', (e)=>{ const z=(e.ctrlKey||e.metaKey)&&!e.shiftKey&&e.key.toLowerCase()==='z'; const y=(e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key.toLowerCase()==='z'; if(z){ e.preventDefault(); undo(); } if(y){ e.preventDefault(); redo(); } });

      // Theme toggle
      document.getElementById('btnDark').addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); });

      // Mode toggle (Autom√°tico/Manual)
      document.getElementById('btnToggleMode').addEventListener('click', ()=>{
        pushHistory();
        state.manualMode = !state.manualMode;
        updateModeUI();
        renderAll();
        saveAuto();
        toast(state.manualMode ? '‚úèÔ∏è Modo manual activado' : 'ü§ñ Modo autom√°tico activado', 'info');
      });

      // Tabs
      document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=> renderTab(b.dataset.tab)));
    }

    function updateModeUI() {
      const btn = document.getElementById('btnToggleMode');
      const label = document.getElementById('modeLabel');
      if (state.manualMode) {
        btn.className = 'px-4 py-2 rounded-lg font-bold transition-all bg-purple-500 text-white';
        label.textContent = '‚úèÔ∏è Manual';
      } else {
        btn.className = 'px-4 py-2 rounded-lg font-bold transition-all bg-indigo-500 text-white';
        label.textContent = 'ü§ñ Autom√°tico';
      }
    }

    function wireZoneButtons(){ document.querySelectorAll('[data-action]').forEach(btn=>{ btn.addEventListener('change', onCardAction); btn.addEventListener('click', onCardAction); }); const apply=document.getElementById('btnApplyRules'); if(apply){ apply.onclick=()=>{ pushHistory(); state.rules.minFreeSundaysPerMonth=parseInt(document.getElementById('ruleSundays').value||2); state.rules.maxConsecutiveWorkDays=parseInt(document.getElementById('ruleStreak').value||6); renderTab('rules'); saveAuto(); } } }

    function onCardAction(e){
      const t=e.currentTarget;
      const act=t.dataset.action;
      if(!act) return;
      const shift=t.dataset.shift;
      const idx=parseInt(t.dataset.idx);
      pushHistory();

      // Usar asignaciones manuales o autom√°ticas seg√∫n el modo
      const assignments = state.manualMode ? state.manualAssignments : state.shiftAssignments;

      if(act==='del'){ assignments[shift].splice(idx,1); renderAll(); saveAuto(); return; }
      if(act==='dup'){ assignments[shift].splice(idx+1,0, clone(assignments[shift][idx])); renderAll(); saveAuto(); return; }
      if(act==='c1'){ assignments[shift][idx].cycle1=t.value; renderAll(); saveAuto(); return; }
      if(act==='c2'){ assignments[shift][idx].cycle2=t.value||null; renderAll(); saveAuto(); return; }
      if(act==='ofs'){ assignments[shift][idx].startOffset=parseInt(t.value||0); renderAll(); saveAuto(); return; }
      if(act==='r1'){ assignments[shift][idx].cycle1Repeat=parseInt(t.value||1); renderAll(); saveAuto(); return; }
    }

    // Drag & Drop con feedback visual
    function wireDnD(){
      let dragged=null;

      document.querySelectorAll('[draggable="true"]').forEach(el=>{
        el.addEventListener('dragstart', (e)=>{
          dragged={ groupId: el.dataset.group, cycle: el.dataset.cycle };
          el.classList.add('dragging');
        });

        el.addEventListener('dragend', ()=>{
          el.classList.remove('dragging');
        });
      });

      document.querySelectorAll('[data-drop-zone]').forEach(zone=>{
        zone.addEventListener('dragover', e=> {
          e.preventDefault();
          zone.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', ()=> {
          zone.classList.remove('drag-over');
        });

        zone.addEventListener('drop', e=>{
          e.preventDefault();
          zone.classList.remove('drag-over');

          if(!dragged) return;
          const key=zone.dataset.dropZone;
          // Usar asignaciones manuales o autom√°ticas seg√∫n el modo
          const list = state.manualMode ? state.manualAssignments[key] : state.shiftAssignments[key];

          if(list.length>=state.maxGroupsPerShift) {
            toast('‚ö†Ô∏è Este turno ya alcanz√≥ el m√°ximo de grupos', 'error');
            return;
          }

          if(list.some(a=> a.groupId===dragged.groupId)) {
            toast('‚ö†Ô∏è Este grupo ya est√° asignado a este turno', 'error');
            return;
          }

          pushHistory();
          list.push({ groupId: dragged.groupId, cycle1: dragged.cycle, cycle2: null, cycle1Repeat: 1, cycle2Repeat: 1, startOffset: 0 });
          dragged=null;
          renderAll();
          saveAuto();
          toast('‚úÖ Grupo asignado exitosamente', 'success');
        });
      });

      // Touch support para mobile
      let touchItem = null;
      document.querySelectorAll('[draggable="true"]').forEach(el => {
        el.addEventListener('touchstart', (e) => {
          touchItem = { groupId: el.dataset.group, cycle: el.dataset.cycle, element: el };
          el.classList.add('dragging');
        });

        el.addEventListener('touchend', (e) => {
          el.classList.remove('dragging');
          const touch = e.changedTouches[0];
          const dropZone = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('[data-drop-zone]');

          if (dropZone && touchItem) {
            const key = dropZone.dataset.dropZone;
            // Usar asignaciones manuales o autom√°ticas seg√∫n el modo
            const list = state.manualMode ? state.manualAssignments[key] : state.shiftAssignments[key];

            if(list.length >= state.maxGroupsPerShift) {
              toast('‚ö†Ô∏è Este turno ya alcanz√≥ el m√°ximo de grupos', 'error');
              touchItem = null;
              return;
            }

            if(list.some(a => a.groupId === touchItem.groupId)) {
              toast('‚ö†Ô∏è Este grupo ya est√° asignado a este turno', 'error');
              touchItem = null;
              return;
            }

            pushHistory();
            list.push({ groupId: touchItem.groupId, cycle1: touchItem.cycle, cycle2: null, cycle1Repeat: 1, cycle2Repeat: 1, startOffset: 0 });
            renderAll();
            saveAuto();
            toast('‚úÖ Grupo asignado exitosamente', 'success');
          }

          touchItem = null;
        });
      });
    }

    // Undo/Redo impl
    const undo=()=>{ if(!undoStack.length) return; const prev=undoStack.pop(); redoStack.push(clone(state)); state=prev; renderAll(); saveAuto(); toast('‚Ü©Ô∏è Cambio deshecho', 'info'); };
    const redo=()=>{ if(!redoStack.length) return; const next=redoStack.pop(); undoStack.push(clone(state)); state=next; renderAll(); saveAuto(); toast('‚Ü™Ô∏è Cambio rehecho', 'info'); };

    const toast=(msg, type='success')=>{
      const el=document.createElement('div');
      el.className=`toast toast-${type}`;
      el.textContent=msg;
      document.body.appendChild(el);
      setTimeout(()=>{
        el.style.opacity='0';
        setTimeout(()=>el.remove(),300);
      },2500);
    };

    const saveAuto=()=> localStorage.setItem('turnos_pro_autosave', JSON.stringify(state));

    function showLoading(message = 'Procesando...') {
      const loader = document.createElement('div');
      loader.id = 'globalLoader';
      loader.className = 'modal-overlay';
      loader.innerHTML = `
        <div class="bg-white rounded-2xl p-8 text-center">
          <div class="spinner mx-auto mb-4"></div>
          <div class="text-lg font-semibold">${message}</div>
        </div>
      `;
      document.body.appendChild(loader);
      return loader;
    }

    function hideLoading() {
      const loader = document.getElementById('globalLoader');
      if (loader) loader.remove();
    }

    function exportXLSX(){
      const loader = showLoading('üìä Generando Excel de 12 meses...');

      // Usar setTimeout para permitir que el loader se muestre
      setTimeout(() => {
        try {
          const {calendar, byGroup} = buildEngine();
          const wb = XLSX.utils.book_new();
          const today = new Date().toISOString().slice(0,10); 
      
      // Hoja de Configuraci√≥n
      const conf = [ 
        ['CONFIGURACI√ìN DEL SISTEMA DE TURNOS'], 
        [], 
        ['Fecha Inicio:', state.startDate], 
        ['Fecha Fin:', state.endDate], 
        [], 
        ['ASIGNACIONES POR TURNO'] 
      ]; 
      ['day','afternoon','night'].forEach(k=>{ 
        const shiftNames = {day:'D√çA', afternoon:'TARDE', night:'NOCHE'};
        conf.push([`Turno ${shiftNames[k]}:`]); 
        state.shiftAssignments[k].forEach(a=> conf.push([
          `  Grupo ${a.groupId}`, 
          `Ciclo 1: ${a.cycle1}`, 
          a.cycle2 ? `Ciclo 2: ${a.cycle2}` : 'Sin ciclo 2',
          `Desfase: ${a.startOffset}`
        ])); 
        conf.push([]); 
      }); 
      const wsC = XLSX.utils.aoa_to_sheet(conf); 
      XLSX.utils.book_append_sheet(wb, wsC, 'Configuraci√≥n');
      
      // Calcular 12 meses desde la fecha de inicio
      const startDate = new Date(state.startDate);
      const monthsList = [];
      for(let i = 0; i < 12; i++) {
        const monthDate = new Date(startDate);
        monthDate.setMonth(startDate.getMonth() + i);
        const yyyyMM = monthDate.toISOString().slice(0, 7);
        monthsList.push(yyyyMM);
      }
      
      // Crear una hoja por cada mes
      monthsList.forEach((yyyyMM, index) => {
        const mg = monthByGroup(byGroup, yyyyMM);
        const days = daysInMonth(yyyyMM);
        
        if(days.length === 0) return; // Saltar si el mes no tiene d√≠as
        
        // Vista por grupos
        const header = ['Grupo', ...days.map(d => d.js.toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit'}))];
        const rows = [header];
        Object.keys(mg).sort().forEach(g => {
          rows.push([`G${g}`, ...mg[g].map(x => 
            x.shift === 'day' ? 'D√≠a' : 
            x.shift === 'afternoon' ? 'Tarde' : 
            x.shift === 'night' ? 'Noche' : 'Descanso'
          )]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const monthName = new Date(yyyyMM + '-01').toLocaleDateString('es-CL', {month:'short', year:'2-digit'}).toUpperCase();
        XLSX.utils.book_append_sheet(wb, ws, `${index + 1}. ${monthName}`);
      });
      
      // Crear hoja consolidada anual
      const allGroups = Object.keys(byGroup).sort();
      const annualHeader = ['Fecha', 'D√≠a Semana', ...allGroups.map(g => `G${g}`)];
      const annualRows = [annualHeader];
      
      // Iterar sobre todos los meses
      monthsList.forEach(yyyyMM => {
        const mg = monthByGroup(byGroup, yyyyMM);
        const days = daysInMonth(yyyyMM);
        
        days.forEach((dayInfo, i) => {
          const dt = dayInfo.js;
          const row = [
            dt.toLocaleDateString('es-CL'),
            dt.toLocaleDateString('es-CL', {weekday:'long'})
          ];
          
          allGroups.forEach(g => {
            const x = mg[g][i];
            row.push(x ? (
              x.shift === 'rest' ? 'Descanso' : 
              x.shift === 'day' ? 'D√≠a' : 
              x.shift === 'afternoon' ? 'Tarde' : 'Noche'
            ) : '');
          });
          
          annualRows.push(row);
        });
      });
      
          const wsAnual = XLSX.utils.aoa_to_sheet(annualRows);
          wsAnual['!cols'] = [
            { wch: 12 },  // Fecha
            { wch: 12 },  // D√≠a
            ...allGroups.map(() => ({ wch: 10 }))  // Grupos
          ];
          XLSX.utils.book_append_sheet(wb, wsAnual, 'RESUMEN ANUAL');
      
      // Crear hoja de estad√≠sticas de domingos
      const sundayStats = {};
      monthsList.forEach(yyyyMM => {
        sundayStats[yyyyMM] = {};
        allGroups.forEach(g => {
          sundayStats[yyyyMM][g] = { working: 0, free: 0, total: 0 };
        });
        
        const mg = monthByGroup(byGroup, yyyyMM);
        const days = daysInMonth(yyyyMM);
        
        days.forEach((dayInfo, i) => {
          if (dayInfo.isSunday) {
            allGroups.forEach(g => {
              const x = mg[g][i];
              sundayStats[yyyyMM][g].total++;
              if (x && x.shift !== 'rest') {
                sundayStats[yyyyMM][g].working++;
              } else {
                sundayStats[yyyyMM][g].free++;
              }
            });
          }
        });
      });
      
      const sundayHeader = ['Mes', ...allGroups.map(g => `G${g} Libres`), ...allGroups.map(g => `G${g} Total`)];
      const sundayRows = [sundayHeader];
      
      monthsList.forEach(yyyyMM => {
        const monthName = new Date(yyyyMM + '-01').toLocaleDateString('es-CL', {year:'numeric', month:'long'});
        const row = [monthName];
        
        allGroups.forEach(g => {
          row.push(sundayStats[yyyyMM][g].free);
        });
        
        allGroups.forEach(g => {
          row.push(sundayStats[yyyyMM][g].total);
        });
        
        sundayRows.push(row);
      });
      
      // Agregar totales
      const totalRow = ['TOTAL A√ëO'];
      allGroups.forEach(g => {
        const totalFree = monthsList.reduce((sum, m) => sum + sundayStats[m][g].free, 0);
        totalRow.push(totalFree);
      });
      allGroups.forEach(g => {
        const totalSundays = monthsList.reduce((sum, m) => sum + sundayStats[m][g].total, 0);
        totalRow.push(totalSundays);
      });
      sundayRows.push(totalRow);
      
      // Agregar promedio mensual
      const avgRow = ['PROMEDIO/MES'];
      allGroups.forEach(g => {
        const totalFree = monthsList.reduce((sum, m) => sum + sundayStats[m][g].free, 0);
        avgRow.push((totalFree / 12).toFixed(1));
      });
      allGroups.forEach(g => {
        const totalSundays = monthsList.reduce((sum, m) => sum + sundayStats[m][g].total, 0);
        avgRow.push((totalSundays / 12).toFixed(1));
      });
      sundayRows.push(avgRow);
      
          const wsSundays = XLSX.utils.aoa_to_sheet(sundayRows);
          XLSX.utils.book_append_sheet(wb, wsSundays, 'DOMINGOS (12 meses)');

          XLSX.writeFile(wb, `Turnos_Anual_${today}.xlsx`);
          hideLoading();
          toast('‚úÖ Excel de 12 meses exportado exitosamente', 'success');
        } catch (error) {
          hideLoading();
          toast('‚ùå Error al generar Excel: ' + error.message, 'error');
          console.error(error);
        }
      }, 100);
    }

    // ---------- MANUAL CALENDAR DRAG & DROP ----------
    function wireManualDnD() {
      let draggedCycle = null;

      // Fichas de ciclos (nueva interfaz)
      document.querySelectorAll('[data-cycle-shift]').forEach(chip => {
        chip.addEventListener('dragstart', (e) => {
          draggedCycle = {
            shift: chip.dataset.cycleShift,
            cycle: chip.dataset.cycleType
          };
          chip.classList.add('dragging');
        });

        chip.addEventListener('dragend', () => {
          chip.classList.remove('dragging');
        });
      });

      // Celdas del calendario (nueva interfaz)
      document.querySelectorAll('[data-drop-manual-day]').forEach(cell => {
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
          cell.classList.add('drag-over');
        });

        cell.addEventListener('dragleave', () => {
          cell.classList.remove('drag-over');
        });

        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          cell.classList.remove('drag-over');

          if (draggedCycle) {
            const date = cell.dataset.dropManualDay;
            pushHistory();
            applyCycleToManual(date, draggedCycle.shift, draggedCycle.cycle);
            renderTab('manual');
            saveAuto();
            toast(`‚úÖ Ciclo ${draggedCycle.cycle} de ${draggedCycle.shift} aplicado desde ${new Date(date).toLocaleDateString('es-CL')}`, 'success');
            draggedCycle = null;
          }
        });
      });

      // Click en d√≠a para eliminar
      document.querySelectorAll('[data-manual-day-cell]').forEach(cell => {
        cell.addEventListener('click', () => {
          const date = cell.dataset.manualDayCell;
          if (state.manualDays[date] && state.manualDays[date] !== 'rest') {
            pushHistory();
            delete state.manualDays[date];
            renderTab('manual');
            saveAuto();
            toast('üóëÔ∏è D√≠a eliminado', 'info');
          }
        });
      });

      // Bot√≥n limpiar todos los d√≠as
      document.getElementById('btnClearManualDays')?.addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de limpiar todos los d√≠as asignados?')) {
          pushHistory();
          state.manualDays = {};
          renderTab('manual');
          saveAuto();
          toast('üßπ Todos los d√≠as limpiados', 'info');
        }
      });
    }

    function assignManualShift(date, shiftId) {
      // Asegurar que manualCalendar exista
      if (!state.manualCalendar) {
        state.manualCalendar = {};
      }

      if (!state.manualCalendar[date]) {
        state.manualCalendar[date] = { shifts: [] };
      }

      // Validaci√≥n: no repetir el mismo turno en un d√≠a
      if (state.manualCalendar[date].shifts.includes(shiftId)) {
        toast(`‚ö†Ô∏è Ya existe un turno de ${getShiftLabel(shiftId)} en este d√≠a`, 'error');
        return;
      }

      pushHistory();
      state.manualCalendar[date].shifts.push(shiftId);
      saveAuto();
      renderTab('manual');
      toast(`‚úÖ Turno de ${getShiftLabel(shiftId)} asignado`, 'success');
    }

    function removeManualShift(date, shiftId) {
      // Asegurar que manualCalendar exista
      if (!state.manualCalendar) {
        state.manualCalendar = {};
      }

      if (!state.manualCalendar[date]) return;

      pushHistory();
      state.manualCalendar[date].shifts = state.manualCalendar[date].shifts.filter(s => s !== shiftId);

      // Limpiar el d√≠a si no tiene turnos
      if (state.manualCalendar[date].shifts.length === 0) {
        delete state.manualCalendar[date];
      }

      saveAuto();
      renderTab('manual');
      toast(`üóëÔ∏è Turno de ${getShiftLabel(shiftId)} eliminado`, 'info');
    }

    function clearManualMonth() {
      // Asegurar que manualCalendar exista
      if (!state.manualCalendar) {
        state.manualCalendar = {};
      }

      const month = state.selectedMonth;
      pushHistory();

      // Eliminar solo los d√≠as del mes actual
      Object.keys(state.manualCalendar).forEach(date => {
        if (date.startsWith(month)) {
          delete state.manualCalendar[date];
        }
      });

      saveAuto();
      renderTab('manual');
      toast('üßπ Mes limpiado completamente', 'info');
    }

    function getShiftLabel(shiftId) {
      const labels = { day: 'D√≠a', afternoon: 'Tarde', night: 'Noche', rest: 'Descanso' };
      return labels[shiftId] || shiftId;
    }

    function exportManualCalendar() {
      // Asegurar que manualCalendar exista
      if (!state.manualCalendar) {
        state.manualCalendar = {};
      }

      const loader = showLoading('üìä Generando Excel del calendario manual...');

      setTimeout(() => {
        try {
          const wb = XLSX.utils.book_new();
          const today = new Date().toISOString().slice(0, 10);

          // Hoja del calendario manual
          const month = state.selectedMonth;
          const days = daysInMonth(month);

          const rows = [
            ['Fecha', 'D√≠a Semana', 'Turnos Asignados'],
            []
          ];

          days.forEach(day => {
            const dateStr = day.date;
            const dayData = state.manualCalendar[dateStr];
            const weekday = day.js.toLocaleDateString('es-CL', { weekday: 'long' });
            const shifts = dayData && dayData.shifts.length > 0
              ? dayData.shifts.map(s => getShiftLabel(s)).join(', ')
              : '-';

            rows.push([
              day.js.toLocaleDateString('es-CL'),
              weekday,
              shifts
            ]);
          });

          const ws = XLSX.utils.aoa_to_sheet(rows);
          ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 30 }];

          XLSX.utils.book_append_sheet(wb, ws, 'Calendario Manual');

          XLSX.writeFile(wb, `Calendario_Manual_${month}_${today}.xlsx`);
          hideLoading();
          toast('‚úÖ Calendario manual exportado exitosamente', 'success');
        } catch (error) {
          hideLoading();
          toast('‚ùå Error al exportar: ' + error.message, 'error');
          console.error(error);
        }
      }, 100);
    }

    // ---------- INIT ----------
    (function init(){
      const auto=localStorage.getItem('turnos_pro_autosave');
      if(auto){ try{ state=JSON.parse(auto);}catch{} }
      if(!state.selectedMonth){ state.selectedMonth = state.startDate.slice(0,7); }
      // Asegurar que propiedades nuevas existan (para compatibilidad con estados antiguos)
      if(!state.manualCalendar){ state.manualCalendar = {}; }
      if(state.manualMode === undefined){ state.manualMode = false; }
      if(!state.manualAssignments){ state.manualAssignments = { day: [], afternoon: [], night: [] }; }
      if(!state.manualDays){ state.manualDays = {}; }

      wireBasics();
      updateModeUI(); // Actualizar UI del modo
      renderAll();
      renderTab('by-group'); // Mostrar pesta√±a por defecto
      updateBreadcrumb();

      // Anunciar p√°gina cargada para lectores de pantalla
      setTimeout(() => {
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = 'Simulador de turnos cargado correctamente. Use Tab para navegar entre controles.';
        document.body.appendChild(announcement);
        setTimeout(() => announcement.remove(), 3000);
      }, 1000);
    })();
  </script>
</body>
</html>
